.PHONY: help build run test deploy clean dev deploy-mysql deploy-app api-examples

# ê¸°ë³¸ ë³€ìˆ˜
IMAGE_NAME = containerssh-auth-server
IMAGE_TAG = latest
NAMESPACE = containerssh

help: ## ë„ì›€ë§ í‘œì‹œ
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-30s\033[0m %s\n", $$1, $$2}'

build: ## Docker ì´ë¯¸ì§€ ë¹Œë“œ
	docker build -t $(IMAGE_NAME):$(IMAGE_TAG) .

run: ## ë¡œì»¬ì—ì„œ ê°œë°œ ì„œë²„ ì‹¤í–‰ (MySQL ì—†ì´)
	uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload

test: ## í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (ê°„ë‹¨í•œ í—¬ìŠ¤ì²´í¬)
	curl -f http://localhost:8000/health || exit 1

dev: ## ê°œë°œ í™˜ê²½ ì…‹ì—…
	pip install -r requirements.txt

deploy-mysql: ## MySQLë§Œ ë°°í¬
	@echo "ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ìƒì„±..."
	kubectl apply -f k8s/namespace.yaml
	@echo "MySQL Secret ì ìš©..."
	kubectl apply -f k8s/mysql-secret.yaml
	@echo "MySQL ConfigMap ì ìš©..."
	kubectl apply -f k8s/mysql-configmap.yaml
	kubectl apply -f k8s/mysql-init-configmap.yaml
	@echo "MySQL Deployment ì ìš©..."
	kubectl apply -f k8s/mysql-deployment.yaml
	@echo "MySQL Service ì ìš©..."
	kubectl apply -f k8s/mysql-service.yaml
	@echo "MySQL ë°°í¬ ì™„ë£Œ! MySQLì´ ì¤€ë¹„ë  ë•Œê¹Œì§€ ì ì‹œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”..."

deploy-app: build ## ì¸ì¦ ì„œë²„ë§Œ ë°°í¬
	@echo "ì´ë¯¸ì§€ë¥¼ í´ëŸ¬ìŠ¤í„°ì— ë¡œë“œ ì¤‘..."
	@if command -v kind >/dev/null 2>&1; then \
		echo "Kind í´ëŸ¬ìŠ¤í„° ê°ì§€ë¨. ì´ë¯¸ì§€ ë¡œë“œ ì¤‘..."; \
		kind load docker-image $(IMAGE_NAME):$(IMAGE_TAG); \
	elif command -v minikube >/dev/null 2>&1; then \
		echo "Minikube í´ëŸ¬ìŠ¤í„° ê°ì§€ë¨. Docker í™˜ê²½ ì„¤ì • ì¤‘..."; \
		eval $(minikube docker-env); \
		docker build -t $(IMAGE_NAME):$(IMAGE_TAG) .; \
	else \
		echo "ì¼ë°˜ Kubernetes í´ëŸ¬ìŠ¤í„°ì—ì„œ ì‹¤í–‰ ì¤‘. ëª¨ë“  ë…¸ë“œì— ì´ë¯¸ì§€ê°€ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”."; \
	fi
	@echo "ConfigMap ì ìš©..."
	kubectl apply -f k8s/configmap.yaml
	@echo "Deployment ì ìš©..."
	kubectl apply -f k8s/deployment.yaml
	@echo "Service ì ìš©..."
	kubectl apply -f k8s/service.yaml
	@echo "ì¸ì¦ ì„œë²„ ë°°í¬ ì™„ë£Œ!"

deploy: deploy-mysql deploy-app ## ì „ì²´ ë°°í¬ (MySQL + ì¸ì¦ ì„œë²„)
	@echo "ì „ì²´ ë°°í¬ ì™„ë£Œ!"

status: ## ë°°í¬ ìƒíƒœ í™•ì¸
	kubectl get all -n $(NAMESPACE)

logs: ## ì¸ì¦ ì„œë²„ ë¡œê·¸ í™•ì¸
	kubectl logs -n $(NAMESPACE) -l app=containerssh-auth-server -f

logs-mysql: ## MySQL ë¡œê·¸ í™•ì¸
	kubectl logs -n $(NAMESPACE) -l app=mysql -f

clean: ## ì •ë¦¬
	kubectl delete namespace $(NAMESPACE) || true
	docker rmi $(IMAGE_NAME):$(IMAGE_TAG) || true

port-forward: ## í¬íŠ¸ í¬ì›Œë”© (API ì‚¬ìš©)
	kubectl port-forward -n $(NAMESPACE) svc/containerssh-auth-service 8080:80

port-forward-mysql: ## MySQL í¬íŠ¸ í¬ì›Œë”© (ë””ë²„ê·¸ìš©)
	kubectl port-forward -n $(NAMESPACE) svc/mysql-service 3306:3306

wait-for-mysql: ## MySQL ì¤€ë¹„ ìƒíƒœ ëŒ€ê¸°
	@echo "MySQLì´ ì¤€ë¹„ë  ë•Œê¹Œì§€ ëŒ€ê¸° ì¤‘..."
	@kubectl wait --for=condition=ready pod -l app=mysql -n $(NAMESPACE) --timeout=300s
	@echo "MySQLì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤!"

restart-app: ## ì¸ì¦ ì„œë²„ ì¬ì‹œì‘
	kubectl rollout restart deployment/containerssh-auth-server -n $(NAMESPACE)

restart-mysql: ## MySQL ì¬ì‹œì‘
	kubectl rollout restart deployment/mysql -n $(NAMESPACE)

api-examples: ## API ì‚¬ìš©ë²• ì˜ˆì‹œ í‘œì‹œ
	@echo "=== ContainerSSH ì¸ì¦ ì„œë²„ API ì‚¬ìš©ë²• ==="
	@echo ""
	@echo "ğŸ”§ í¬íŠ¸ í¬ì›Œë”© ì‹œì‘:"
	@echo "  make port-forward"
	@echo ""
	@echo "ğŸ“‹ ì‚¬ìš©ì ëª©ë¡ ì¡°íšŒ:"
	@echo "  curl http://localhost:8080/users"
	@echo ""
	@echo "ğŸ‘¤ ìƒˆ ì‚¬ìš©ì ì¶”ê°€:"
	@echo "  curl -X POST http://localhost:8080/users \\"
	@echo "    -H \"Content-Type: application/json\" \\"
	@echo "    -d '{\"username\":\"test123\",\"password\":\"test123\"}'"
	@echo ""
	@echo "ğŸ” íŠ¹ì • ì‚¬ìš©ì ì¡°íšŒ:"
	@echo "  curl http://localhost:8080/users/test123"
	@echo ""
	@echo "ğŸ”‘ ê³µê°œí‚¤ ëª©ë¡ ì¡°íšŒ:"
	@echo "  curl http://localhost:8080/users/test123/keys"
	@echo ""
	@echo "â• ê³µê°œí‚¤ ì¶”ê°€:"
	@echo "  curl -X POST http://localhost:8080/users/test123/keys \\"
	@echo "    -H \"Content-Type: application/json\" \\"
	@echo "    -d '{\"public_key\":\"ssh-rsa AAAAB3...\",\"key_name\":\"laptop\"}'"
	@echo ""
	@echo "ğŸ—‘ï¸  ì‚¬ìš©ì ì‚­ì œ:"
	@echo "  curl -X DELETE http://localhost:8080/users/test123"
	@echo ""
	@echo "ğŸ¥ í—¬ìŠ¤ì²´í¬:"
	@echo "  curl http://localhost:8080/health"
	@echo ""
	@echo "ğŸ“Š API ë¬¸ì„œ (Swagger UI):"
	@echo "  http://localhost:8080/docs"
	@echo ""
	@echo "ğŸ“„ API ìŠ¤í‚¤ë§ˆ (ReDoc):"
	@echo "  http://localhost:8080/redoc"

add-user-api: ## APIë¥¼ í†µí•œ ì‚¬ìš©ì ì¶”ê°€ (USER=username PASSWORD=password)
	@if [ -z "$(USER)" ] || [ -z "$(PASSWORD)" ]; then \
		echo "ì‚¬ìš©ë²•: make add-user-api USER=username PASSWORD=password"; \
		echo "ì˜ˆì‹œ: make add-user-api USER=test123 PASSWORD=test123"; \
		exit 1; \
	fi
	@echo "APIë¥¼ í†µí•´ ì‚¬ìš©ì $(USER) ì¶”ê°€ ì¤‘..."
	@curl -X POST http://localhost:8080/users \
		-H "Content-Type: application/json" \
		-d '{"username":"$(USER)","password":"$(PASSWORD)"}' \
		-w "\n" || echo "âŒ í¬íŠ¸ í¬ì›Œë”©ì´ í•„ìš”í•©ë‹ˆë‹¤: make port-forward"

list-users-api: ## APIë¥¼ í†µí•œ ì‚¬ìš©ì ëª©ë¡ ì¡°íšŒ
	@echo "APIë¥¼ í†µí•´ ì‚¬ìš©ì ëª©ë¡ ì¡°íšŒ ì¤‘..."
	@curl http://localhost:8080/users -w "\n" || echo "âŒ í¬íŠ¸ í¬ì›Œë”©ì´ í•„ìš”í•©ë‹ˆë‹¤: make port-forward"

test-password: ## íŒ¨ìŠ¤ì›Œë“œ ì¸ì¦ í…ŒìŠ¤íŠ¸
	curl -X POST http://localhost:8080/password \
		-H "Content-Type: application/json" \
		-d '{"username":"admin","remoteAddress":"127.0.0.1:1234","connectionId":"test-conn","passwordBase64":"c2VjcmV0"}'

test-pubkey: ## ê³µê°œí‚¤ ì¸ì¦ í…ŒìŠ¤íŠ¸
	curl -X POST http://localhost:8080/pubkey \
		-H "Content-Type: application/json" \
		-d '{"username":"admin","remoteAddress":"127.0.0.1:1234","connectionId":"test-conn","publicKey":"ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC..."}'

dev-mysql: ## ë¡œì»¬ MySQL ì»¨í…Œì´ë„ˆ ì‹¤í–‰ (ê°œë°œìš©)
	docker run --name mysql-dev -e MYSQL_ROOT_PASSWORD=rootpassword123 -e MYSQL_DATABASE=containerssh_auth -e MYSQL_USER=containerssh -e MYSQL_PASSWORD=containerssh123 -p 3306:3306 -d mysql:8.0

dev-mysql-stop: ## ë¡œì»¬ MySQL ì»¨í…Œì´ë„ˆ ì¤‘ì§€
	docker stop mysql-dev && docker rm mysql-dev
